#!/usr/bin/env python3
# Wazuh Integration: Forward high-severity alerts to Discord
# Place in /var/ossec/integrations/ with permissions 750 root:wazuh

import sys
import json
import requests

WEBHOOK_URL = "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN"

def main():
    alert_file = sys.argv[1] if len(sys.argv) > 1 else None

    if not alert_file:
        sys.exit(1)

    try:
        with open(alert_file) as f:
            data = json.load(f)
    except:
        sys.exit(1)

    alert = data.get("parameters", {}).get("alert", data)
    rule = alert.get("rule", {})
    agent = alert.get("agent", {})

    level = rule.get("level", 0)
    rule_id = rule.get("id", "N/A")
    description = rule.get("description", "No description")
    agent_name = agent.get("name", "manager")
    timestamp = alert.get("timestamp", "N/A")
    full_log = alert.get("full_log", "")[:500]

    if level >= 14:
        color = 10038562
        severity = "CRITICAL"
        emoji = "\U0001f534"
    elif level >= 12:
        color = 15158332
        severity = "HIGH"
        emoji = "\U0001f7e0"
    elif level >= 10:
        color = 15105570
        severity = "MEDIUM-HIGH"
        emoji = "\U0001f7e1"
    else:
        color = 3447003
        severity = "MEDIUM"
        emoji = "\U0001f535"

    mitre = rule.get("mitre", {})
    mitre_ids = mitre.get("id", [])
    mitre_str = ", ".join(mitre_ids) if mitre_ids else "N/A"

    payload = {
        "embeds": [{
            "title": f"{emoji} Wazuh Alert - {severity}",
            "color": color,
            "fields": [
                {"name": "Level", "value": str(level), "inline": True},
                {"name": "Rule ID", "value": str(rule_id), "inline": True},
                {"name": "Agent", "value": agent_name, "inline": True},
                {"name": "MITRE ATT&CK", "value": mitre_str, "inline": True},
                {"name": "Description", "value": description[:1024], "inline": False}
            ],
            "footer": {"text": f"Wazuh SIEM | {timestamp}"}
        }]
    }

    if full_log:
        log_text = full_log[:900].replace("`", "")
        payload["embeds"][0]["fields"].append({
            "name": "Details",
            "value": f"```{log_text}```",
            "inline": False
        })

    try:
        requests.post(WEBHOOK_URL, json=payload, timeout=10)
    except:
        pass

if __name__ == "__main__":
    main()
