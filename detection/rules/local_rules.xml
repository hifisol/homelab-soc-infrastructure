<group name="local,windows,">
  <!-- Whitelist Display Name changes by SYSTEM on workstation (MS account sync) -->
  <rule id="100001" level="0">
    <if_sid>60110</if_sid>
    <hostname>win-workstation</hostname>
    <field name="win.eventdata.subjectUserSid">S-1-5-18</field>
    <field name="win.eventdata.displayName">\.+</field>
    <description>Ignore display name changes by SYSTEM (Microsoft account sync)</description>
  </rule>

  <!-- Whitelist PowerShell execution policy test files in user Temp (normal PS behavior) -->
  <rule id="100002" level="0">
    <if_sid>92213</if_sid>
    <field name="win.eventdata.targetFilename" type="pcre2">__PSScriptPolicyTest_.+\.ps1$</field>
    <description>Ignore PowerShell script policy test files</description>
  </rule>

  <!-- Whitelist PowerShell execution policy test files in SystemTemp (normal PS behavior) -->
  <rule id="100003" level="0">
    <if_sid>92205</if_sid>
    <field name="win.eventdata.targetFilename" type="pcre2">__PSScriptPolicyTest_.+\.ps1$</field>
    <description>Ignore PowerShell script policy test files in SystemTemp</description>
  </rule>

  <!-- Whitelist Dell UpdateService inventory collectors (legitimate Dell software) -->
  <rule id="100004" level="0">
    <if_sid>100072</if_sid>
    <field name="win.eventdata.image" type="pcre2">C:\\Program Files \\(x86\\)\\Dell\\UpdateService\\</field>
    <description>Ignore Dell UpdateService inventory tools</description>
  </rule>

  <!-- Whitelist sdbinst.exe launched by PcaSvc (Program Compatibility Assistant maintenance) -->
  <rule id="100005" level="0">
    <if_sid>92058</if_sid>
    <field name="win.eventdata.parentCommandLine" type="pcre2">svchost\.exe.+-s PcaSvc</field>
    <field name="win.eventdata.commandLine" type="pcre2">sdbinst\.exe\s+-m\s+-bg</field>
    <description>Ignore sdbinst.exe maintenance mode from PcaSvc service</description>
  </rule>

  <!-- Whitelist explorer.exe COM activation from DcomLaunch -->
  <rule id="100006" level="0">
    <if_sid>61640</if_sid>
    <field name="win.eventdata.parentCommandLine" type="pcre2">svchost\.exe.+-k DcomLaunch</field>
    <field name="win.eventdata.commandLine" type="pcre2">explorer\.exe.+/factory,.+-Embedding</field>
    <description>Ignore explorer.exe COM component activation from DcomLaunch</description>
  </rule>

  <!-- Whitelist Killer Network Manager scheduled task launches -->
  <rule id="100007" level="0">
    <if_sid>61640</if_sid>
    <field name="win.eventdata.parentCommandLine" type="pcre2">svchost\.exe.+-s Schedule</field>
    <field name="win.eventdata.commandLine" type="pcre2">explorer\.exe.*killernetworkmanagerlauncher</field>
    <description>Ignore Killer Network Manager scheduled task via explorer.exe</description>
  </rule>

  <!-- Whitelist Tailscale netsh firewall rule additions -->
  <rule id="100008" level="0">
    <if_sid>92043</if_sid>
    <field name="win.eventdata.parentImage" type="pcre2">Tailscale\\tailscaled\.exe$</field>
    <field name="win.eventdata.commandLine" type="pcre2">netsh\.exe.+advfirewall.+Tailscale</field>
    <description>Ignore Tailscale VPN firewall rule management</description>
  </rule>

  <!-- Whitelist Intel DPTF application errors (thermal framework driver noise) -->
  <rule id="100009" level="0">
    <if_sid>60602</if_sid>
    <field name="win.eventdata.message" type="pcre2">ESIF.*DPTF.*Energy Performance Optimizer Policy</field>
    <description>Ignore Intel DPTF thermal framework errors</description>
  </rule>

  <!-- Whitelist Intel ISH Offload Item Service errors -->
  <rule id="100010" level="0">
    <if_sid>60602</if_sid>
    <field name="win.eventdata.data" type="pcre2">ISH Offload Item Service.*heci device state fail</field>
    <description>Ignore Intel ISH Offload Service HECI errors</description>
  </rule>

  <!-- Whitelist hosts.ics integrity changes (Windows ICS auto-managed) -->
  <rule id="100011" level="0">
    <if_sid>550</if_sid>
    <field name="syscheck.path" type="pcre2">(?i)hosts\.ics$</field>
    <description>Ignore Windows ICS hosts file changes</description>
  </rule>

  <!-- Whitelist Velociraptor writeback config backup changes -->
  <rule id="100012" level="0">
    <if_sid>550</if_sid>
    <field name="syscheck.path" type="pcre2">velociraptor\.writeback\.yaml\.bak$</field>
    <description>Ignore Velociraptor config writeback backup changes</description>
  </rule>

  <!-- Whitelist Brave browser update installer drops (legitimate update behavior) -->
  <rule id="100013" level="0">
    <if_sid>92213</if_sid>
    <field name="win.eventdata.image" type="pcre2">BraveSoftware\\Update\\BraveUpdate\.exe$</field>
    <field name="win.eventdata.targetFilename" type="pcre2">\\Temp\\.*brave_installer.*\.exe$</field>
    <description>Brave browser update installer in user Temp folder</description>
  </rule>

  <!-- Whitelist legitimate Windows printer driver DLLs in staging folder (PrintNightmare FP) -->
  <rule id="100014" level="0">
    <if_sid>92206</if_sid>
    <field name="win.eventdata.targetFilename" type="pcre2">\\spool\\drivers\\(x64|W32X86)\\3\\New\\(PrintConfig|MXDWDRV|FXSAPI|FXSDRV|FXSRES|FXSTIFF|FXSUI|FXSWZRD|PJLMON|PS5UI|PSCRIPT5|UNIDRV|UNIDRVUI|UNIRES)\.dll$</field>
    <description>Legitimate Windows printer driver DLLs in staging folder</description>
  </rule>

  <!-- Whitelist Wireshark component installers (Npcap, USBPcap) dropping files to Temp -->
  <rule id="100015" level="0">
    <if_sid>92213</if_sid>
    <field name="win.eventdata.image" type="pcre2">C:\\Program Files\\Wireshark\\(npcap-.*\.exe|USBPcapSetup-.*\.exe)</field>
    <description>Wireshark component installer (Npcap/USBPcap) temp files</description>
  </rule>
</group>

<!-- UniFi/UDM Pro Rules -->
<group name="local,unifi,udm,">

  <!-- UDM Pro CEF Event Decoder Parent Rule -->
  <rule id="100100" level="3">
    <match>CEF: 0|Ubiquiti|UniFi</match>
    <description>UniFi CEF event detected</description>
    <group>unifi,cef,</group>
  </rule>

  <!-- UniFi Client Connected -->
  <rule id="100101" level="3">
    <if_sid>100100</if_sid>
    <match>Client Connected</match>
    <description>UniFi: Client connected to network</description>
    <group>unifi,connection,</group>
  </rule>

  <!-- UniFi Client Disconnected -->
  <rule id="100102" level="3">
    <if_sid>100100</if_sid>
    <match>Client Disconnected</match>
    <description>UniFi: Client disconnected from network</description>
    <group>unifi,connection,</group>
  </rule>

  <!-- UDM IDS/IPS Events -->
  <rule id="100110" level="5">
    <match>idsips|IDS|IPS|threat|dpiSignature</match>
    <description>UDM: IDS/IPS event detected</description>
    <group>unifi,ids,ips,</group>
  </rule>

  <!-- UDM Firewall Block Events -->
  <rule id="100111" level="6">
    <program_name>^UDMPro$</program_name>
    <match>BLOCK|DROP|REJECT|DENY</match>
    <description>UDM: Firewall block event</description>
    <group>unifi,firewall,</group>
  </rule>

  <!-- UDM TOR Block -->
  <rule id="100112" level="10">
    <match>TOR BLOCK</match>
    <description>UDM: TOR traffic blocked</description>
    <group>unifi,threat,tor,</group>
  </rule>

  <!-- UDM Threat Management Block -->
  <rule id="100113" level="10">
    <match>ALIEN BLOCK</match>
    <description>UDM: Threat Management blocked malicious traffic</description>
    <group>unifi,threat,alien,</group>
  </rule>

  <!-- UniFi Switch Port State Change -->
  <rule id="100120" level="3">
    <match>Port \d+ link down|Port \d+ link up</match>
    <description>UniFi: Switch port state change</description>
    <group>unifi,switch,</group>
  </rule>

  <!-- UniFi AP Wireless Client Authentication -->
  <rule id="100121" level="3">
    <match>STA_JOIN|recv auth_req|recv assoc_req</match>
    <description>UniFi: Wireless client authentication event</description>
    <group>unifi,wireless,</group>
  </rule>

  <!-- UniFi AP Wireless Client Deauthentication -->
  <rule id="100122" level="3">
    <match>STA_LEAVE|Deauth</match>
    <description>UniFi: Wireless client deauthentication</description>
    <group>unifi,wireless,</group>
  </rule>

  <!-- =================================================================== -->
  <!-- WiFi Attack Detection Rules (100130-100139)                        -->
  <!-- Detects deauthentication floods, evil twin APs, PMKID harvesting,  -->
  <!-- and other wireless attack vectors via UniFi AP syslog.             -->
  <!-- MITRE ATT&CK: T1557.002 (ARP Poisoning), T1498 (DoS)             -->
  <!-- =================================================================== -->

  <!-- Deauthentication Flood Detection -->
  <!-- UniFi APs log "Deauth" and "STA_LEAVE" events. A burst of these    -->
  <!-- from many clients in a short window indicates a deauth attack.     -->
  <!-- Frequency: 10+ deauth events in 60 seconds from same AP.          -->
  <rule id="100130" level="12" frequency="10" timeframe="60">
    <if_matched_sid>100122</if_matched_sid>
    <description>WiFi Attack: Deauthentication flood detected - possible aireplay-ng / mdk3 / mdk4 attack</description>
    <mitre>
      <id>T1498</id>
    </mitre>
    <group>unifi,wireless,attack,wifi_deauth,</group>
  </rule>

  <!-- Aggressive Deauth Storm (high volume) -->
  <!-- 30+ deauth events in 30 seconds = active attack in progress.      -->
  <rule id="100131" level="14" frequency="30" timeframe="30">
    <if_matched_sid>100122</if_matched_sid>
    <description>WiFi Attack: Deauthentication storm - active wireless DoS attack in progress</description>
    <mitre>
      <id>T1498</id>
    </mitre>
    <group>unifi,wireless,attack,wifi_deauth,</group>
  </rule>

  <!-- Rapid Client Reconnection (post-deauth) -->
  <!-- Many re-associations after deauths suggests clients are being      -->
  <!-- forced to reconnect (deauth â†’ capture handshake pattern).          -->
  <rule id="100132" level="10" frequency="15" timeframe="60">
    <if_matched_sid>100121</if_matched_sid>
    <description>WiFi Attack: Rapid client re-association burst - possible WPA handshake capture attempt</description>
    <mitre>
      <id>T1557</id>
    </mitre>
    <group>unifi,wireless,attack,wifi_handshake,</group>
  </rule>

  <!-- Evil Twin / Rogue AP Detection -->
  <!-- UniFi controllers log rogue AP detection events. These indicate    -->
  <!-- an unauthorized access point, potentially spoofing a legitimate    -->
  <!-- SSID for credential harvesting or MITM.                           -->
  <rule id="100133" level="12">
    <if_sid>100100</if_sid>
    <match>rogue|Rogue AP|RogueAP|unknown AP|neighboring AP</match>
    <description>WiFi Attack: Rogue/unknown access point detected - possible evil twin attack</description>
    <mitre>
      <id>T1557.002</id>
    </mitre>
    <group>unifi,wireless,attack,rogue_ap,</group>
  </rule>

  <!-- Wireless Authentication Flood -->
  <!-- Mass authentication requests indicate a brute-force or DoS attack -->
  <!-- against the wireless infrastructure (e.g., EAPHammer, hostapd-wpe). -->
  <rule id="100134" level="10" frequency="20" timeframe="60">
    <if_matched_sid>100121</if_matched_sid>
    <same_source_ip />
    <description>WiFi Attack: Authentication flood from single source - possible brute force or EAP attack</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>unifi,wireless,attack,wifi_bruteforce,</group>
  </rule>

  <!-- Repeated SSID Probe Requests (reconnaissance) -->
  <!-- Excessive probe requests may indicate wireless reconnaissance      -->
  <!-- tools like airodump-ng, Kismet, or WiFi Pineapple.               -->
  <rule id="100135" level="8">
    <if_sid>100100</if_sid>
    <match>probe|Probe Request|ProbeReq</match>
    <description>WiFi Recon: Excessive probe requests detected - possible wireless reconnaissance</description>
    <mitre>
      <id>T1595</id>
    </mitre>
    <group>unifi,wireless,recon,wifi_probe,</group>
  </rule>

</group>

<!-- Zeek Promiscuous Mode Whitelist -->
<group name="local,syslog,">
  <rule id="100016" level="0">
    <if_sid>5104</if_sid>
    <hostname>threat-hunter</hostname>
    <description>Ignore promiscuous mode on threat hunting server (Zeek packet capture)</description>
  </rule>
</group>
