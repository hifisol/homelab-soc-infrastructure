---
# Ansible Playbook: Setup New User with Sudo and SSH Keys
# Creates a user with sudo access and configures SSH key authentication
#
# Usage:
#   # Create user on all Linux hosts
#   ansible-playbook -i inventory.ini setup-user.yml -e "username=newuser"
#
#   # Create user on specific host
#   ansible-playbook -i inventory.ini setup-user.yml -e "username=newuser" -l workstation
#
#   # With custom SSH key
#   ansible-playbook -i inventory.ini setup-user.yml \
#     -e "username=newuser" \
#     -e "ssh_public_key='ssh-rsa AAAA... user@host'"
#
#   # With password (will prompt)
#   ansible-playbook -i inventory.ini setup-user.yml \
#     -e "username=newuser" \
#     -e "user_password='hashed_password'"
#
#   # Generate password hash:
#   python3 -c "import crypt; print(crypt.crypt('yourpassword', crypt.mksalt(crypt.METHOD_SHA512)))"

- name: Setup New User with Sudo and SSH Keys
  hosts: linux
  become: yes
  gather_facts: yes
  vars:
    # Required - set via -e "username=..."
    username: ""

    # Optional - defaults to deploy-svc public key if not provided
    ssh_public_key: ""
    ssh_key_file: "~/.ssh/deploy-svc.pub"

    # Optional - if not set, password login disabled (SSH key only)
    user_password: ""

    # User settings
    user_shell: /bin/bash
    user_groups:
      - sudo
    create_home: yes

    # SSH settings
    ssh_dir_mode: "0700"
    authorized_keys_mode: "0600"

  pre_tasks:
    - name: Validate username is provided
      fail:
        msg: "Username is required. Use -e 'username=newuser'"
      when: username == ""

    - name: Load SSH public key from file if not provided directly
      set_fact:
        ssh_public_key: "{{ lookup('file', ssh_key_file) }}"
      when: ssh_public_key == "" and ssh_key_file != ""
      delegate_to: localhost
      become: no
      ignore_errors: yes

  tasks:
    - name: Create user group
      group:
        name: "{{ username }}"
        state: present

    - name: Create user account
      user:
        name: "{{ username }}"
        group: "{{ username }}"
        groups: "{{ user_groups }}"
        shell: "{{ user_shell }}"
        create_home: "{{ create_home }}"
        password: "{{ user_password | default(omit) }}"
        state: present
      register: user_created

    - name: Create .ssh directory
      file:
        path: "/home/{{ username }}/.ssh"
        state: directory
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: "{{ ssh_dir_mode }}"

    - name: Add SSH public key to authorized_keys
      authorized_key:
        user: "{{ username }}"
        key: "{{ ssh_public_key }}"
        state: present
        exclusive: no
      when: ssh_public_key != ""

    - name: Set correct permissions on authorized_keys
      file:
        path: "/home/{{ username }}/.ssh/authorized_keys"
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: "{{ authorized_keys_mode }}"
      when: ssh_public_key != ""

    - name: Configure sudoers for user (passwordless sudo)
      copy:
        content: "{{ username }} ALL=(ALL) NOPASSWD: ALL\n"
        dest: "/etc/sudoers.d/{{ username }}"
        mode: "0440"
        owner: root
        group: root
        validate: "visudo -cf %s"

    - name: Verify sudoers file syntax
      command: visudo -c
      changed_when: false

    - name: Display user setup summary
      debug:
        msg: |
          === User Created on {{ inventory_hostname }} ===
          Username: {{ username }}
          Home: /home/{{ username }}
          Shell: {{ user_shell }}
          Groups: {{ user_groups | join(', ') }}
          Sudo: Passwordless (via /etc/sudoers.d/{{ username }})
          SSH Key: {{ 'Configured' if ssh_public_key != '' else 'Not configured' }}

          To connect:
            ssh {{ username }}@{{ ansible_host | default(inventory_hostname) }}

# Verification tasks
- name: Verify User Setup
  hosts: linux
  become: yes
  gather_facts: no
  tasks:
    - name: Verify user exists
      command: "id {{ username }}"
      register: user_verify
      changed_when: false

    - name: Verify sudo access
      command: "sudo -l -U {{ username }}"
      register: sudo_verify
      changed_when: false

    - name: Verify SSH directory permissions
      stat:
        path: "/home/{{ username }}/.ssh"
      register: ssh_dir_stat

    - name: Verify authorized_keys permissions
      stat:
        path: "/home/{{ username }}/.ssh/authorized_keys"
      register: auth_keys_stat
      ignore_errors: yes

    - name: Verification Report
      debug:
        msg: |
          === Verification: {{ inventory_hostname }} ===
          User ID: {{ user_verify.stdout }}
          Sudo: {{ 'OK' if 'NOPASSWD' in sudo_verify.stdout else 'Check config' }}
          SSH Dir Mode: {{ ssh_dir_stat.stat.mode | default('N/A') }} (should be 0700)
          Auth Keys Mode: {{ auth_keys_stat.stat.mode | default('N/A') }} (should be 0600)
