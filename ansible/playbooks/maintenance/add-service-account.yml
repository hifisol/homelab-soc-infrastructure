---
- name: Create deploy-svc user and install authorized key
  hosts: all
  become: yes
  vars:
    ansible_svc_key: "{{ service_account_public_key }} deploy-svc@management"

  tasks:
    - name: Ensure 'deploy-svc' group exists
      ansible.builtin.group:
        name: deploy-svc
        state: present
      tags: [deploy-svc, ssh-keys]

    - name: Ensure 'deploy-svc' user exists
      ansible.builtin.user:
        name: deploy-svc
        comment: "Ansible service account"
        groups: sudo
        append: yes
        shell: /bin/bash
        create_home: yes
        state: present
      tags: [deploy-svc, ssh-keys]

    - name: Create .ssh directory for deploy-svc
      ansible.builtin.file:
        path: /home/deploy-svc/.ssh
        state: directory
        owner: deploy-svc
        group: deploy-svc
        mode: '0700'
      tags: [deploy-svc, ssh-keys]

    - name: Install authorized key for deploy-svc
      ansible.builtin.authorized_key:
        user: deploy-svc
        state: present
        key: "{{ ansible_svc_key }}"
      tags: [deploy-svc, ssh-keys]

    - name: Ensure sudoers entry for deploy-svc (NOPASSWD)
      ansible.builtin.copy:
        dest: /etc/sudoers.d/deploy-svc
        content: |
          deploy-svc ALL=(ALL) NOPASSWD:ALL
        owner: root
        group: root
        mode: '0440'
      tags: [deploy-svc, ssh-keys]

    - name: Ensure home ownership and perms are correct
      ansible.builtin.file:
        path: /home/deploy-svc
        state: directory
        owner: deploy-svc
        group: deploy-svc
        recurse: yes
      tags: [deploy-svc, ssh-keys]
