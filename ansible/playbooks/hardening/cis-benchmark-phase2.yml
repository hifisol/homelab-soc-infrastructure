---
- name: CIS Debian 11 Phase 2 Remediation - WLANPI
  hosts: wlanpi_target
  become: yes

  tasks:
    # ====================================
    # AIDE - FILESYSTEM INTEGRITY
    # ====================================
    - name: Initialize AIDE database
      shell: aideinit
      args:
        creates: /var/lib/aide/aide.db
      async: 1800
      poll: 0
      register: aide_init

    - name: Create AIDE cron job for daily checks
      cron:
        name: "Run AIDE integrity check"
        minute: "0"
        hour: "5"
        job: "/usr/bin/aide --check"
        user: root

    # ====================================
    # APPARMOR
    # ====================================
    - name: Install AppArmor
      apt:
        name:
          - apparmor
          - apparmor-utils
        state: present

    - name: Enable AppArmor
      systemd:
        name: apparmor
        enabled: yes
        state: started

    # ====================================
    # LOGIN BANNERS
    # ====================================
    - name: Configure /etc/issue (local login banner)
      copy:
        dest: /etc/issue
        content: |
          **********************************************************************
          *                                                                    *
          *  Authorized access only!                                          *
          *  Unauthorized access to this system is forbidden and will be      *
          *  prosecuted by law.                                               *
          *                                                                    *
          **********************************************************************
        mode: '0644'

    - name: Configure /etc/issue.net (remote login banner)
      copy:
        dest: /etc/issue.net
        content: |
          **********************************************************************
          *                                                                    *
          *  Authorized access only!                                          *
          *  Unauthorized access to this system is forbidden and will be      *
          *  prosecuted by law.                                               *
          *                                                                    *
          **********************************************************************
        mode: '0644'

    - name: SSH - Configure login banner
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Banner'
        line: 'Banner /etc/issue.net'
        state: present
      notify: restart ssh

    # ====================================
    # TIME SYNCHRONIZATION
    # ====================================
    - name: Stop and disable ntp if installed
      systemd:
        name: ntp
        enabled: no
        state: stopped
      ignore_errors: yes

    - name: Configure systemd-timesyncd
      copy:
        dest: /etc/systemd/timesyncd.conf
        content: |
          [Time]
          NTP=time.nist.gov pool.ntp.org
          FallbackNTP=time.windows.com time.google.com
        mode: '0644'
      notify: restart timesyncd

    - name: Enable and start systemd-timesyncd
      systemd:
        name: systemd-timesyncd
        enabled: yes
        state: started
      ignore_errors: yes

    # ====================================
    # ADDITIONAL SSH HARDENING
    # ====================================
    - name: SSH - Disable TCP forwarding
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?AllowTcpForwarding'
        line: 'AllowTcpForwarding no'
        state: present
      notify: restart ssh

    - name: SSH - Configure MaxStartups
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?MaxStartups'
        line: 'MaxStartups 10:30:60'
        state: present
      notify: restart ssh

    - name: SSH - Configure LoginGraceTime
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?LoginGraceTime'
        line: 'LoginGraceTime 60'
        state: present
      notify: restart ssh

    # ====================================
    # COMPREHENSIVE AUDIT RULES
    # ====================================
    - name: Add audit rule - sudoers changes
      copy:
        dest: /etc/audit/rules.d/sudoers.rules
        content: |
          -w /etc/sudoers -p wa -k scope
          -w /etc/sudoers.d/ -p wa -k scope
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - sudo execution
      copy:
        dest: /etc/audit/rules.d/sudo.rules
        content: |
          -a always,exit -F arch=b64 -C euid!=uid -F auid!=unset -S execve -k user_emulation
          -a always,exit -F arch=b32 -C euid!=uid -F auid!=unset -S execve -k user_emulation
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - time changes
      copy:
        dest: /etc/audit/rules.d/time.rules
        content: |
          -a always,exit -F arch=b64 -S adjtimex,settimeofday -k time-change
          -a always,exit -F arch=b32 -S adjtimex,settimeofday,stime -k time-change
          -a always,exit -F arch=b64 -S clock_settime -F a0=0x0 -k time-change
          -a always,exit -F arch=b32 -S clock_settime -F a0=0x0 -k time-change
          -w /etc/localtime -p wa -k time-change
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - network environment
      copy:
        dest: /etc/audit/rules.d/network.rules
        content: |
          -a always,exit -F arch=b64 -S sethostname,setdomainname -k system-locale
          -a always,exit -F arch=b32 -S sethostname,setdomainname -k system-locale
          -w /etc/issue -p wa -k system-locale
          -w /etc/issue.net -p wa -k system-locale
          -w /etc/hosts -p wa -k system-locale
          -w /etc/network -p wa -k system-locale
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - file access attempts
      copy:
        dest: /etc/audit/rules.d/access.rules
        content: |
          -a always,exit -F arch=b64 -S open,truncate,ftruncate,creat,openat,open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=unset -k access
          -a always,exit -F arch=b64 -S open,truncate,ftruncate,creat,openat,open_by_handle_at -F exit=-EPERM -F auid>=1000 -F auid!=unset -k access
          -a always,exit -F arch=b32 -S open,truncate,ftruncate,creat,openat,open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=unset -k access
          -a always,exit -F arch=b32 -S open,truncate,ftruncate,creat,openat,open_by_handle_at -F exit=-EPERM -F auid>=1000 -F auid!=unset -k access
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - user/group changes
      copy:
        dest: /etc/audit/rules.d/usergroup.rules
        content: |
          -w /etc/group -p wa -k identity
          -w /etc/passwd -p wa -k identity
          -w /etc/gshadow -p wa -k identity
          -w /etc/shadow -p wa -k identity
          -w /etc/security/opasswd -p wa -k identity
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - DAC modifications
      copy:
        dest: /etc/audit/rules.d/dac.rules
        content: |
          -a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -k perm_mod
          -a always,exit -F arch=b64 -S chown,fchown,lchown,fchownat -F auid>=1000 -F auid!=unset -k perm_mod
          -a always,exit -F arch=b64 -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=unset -k perm_mod
          -a always,exit -F arch=b32 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -k perm_mod
          -a always,exit -F arch=b32 -S chown,fchown,lchown,fchownat -F auid>=1000 -F auid!=unset -k perm_mod
          -a always,exit -F arch=b32 -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=unset -k perm_mod
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - mounts
      copy:
        dest: /etc/audit/rules.d/mounts.rules
        content: |
          -a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=unset -k mounts
          -a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=unset -k mounts
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - file deletions
      copy:
        dest: /etc/audit/rules.d/delete.rules
        content: |
          -a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat -F auid>=1000 -F auid!=unset -k delete
          -a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat -F auid>=1000 -F auid!=unset -k delete
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - MAC changes
      copy:
        dest: /etc/audit/rules.d/mac.rules
        content: |
          -w /etc/apparmor/ -p wa -k MAC-policy
          -w /etc/apparmor.d/ -p wa -k MAC-policy
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - chcon command
      copy:
        dest: /etc/audit/rules.d/chcon.rules
        content: |
          -a always,exit -F path=/usr/bin/chcon -F perm=x -F auid>=1000 -F auid!=unset -k perm_chng
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - setfacl command
      copy:
        dest: /etc/audit/rules.d/setfacl.rules
        content: |
          -a always,exit -F path=/usr/bin/setfacl -F perm=x -F auid>=1000 -F auid!=unset -k perm_chng
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - chacl command
      copy:
        dest: /etc/audit/rules.d/chacl.rules
        content: |
          -a always,exit -F path=/usr/bin/chacl -F perm=x -F auid>=1000 -F auid!=unset -k perm_chng
        mode: '0640'
      notify: restart auditd
      ignore_errors: yes

    - name: Add audit rule - usermod command
      copy:
        dest: /etc/audit/rules.d/usermod.rules
        content: |
          -a always,exit -F path=/usr/sbin/usermod -F perm=x -F auid>=1000 -F auid!=unset -k usermod
        mode: '0640'
      notify: restart auditd

    - name: Add audit rule - kernel modules
      copy:
        dest: /etc/audit/rules.d/modules.rules
        content: |
          -a always,exit -F arch=b64 -S init_module,finit_module,delete_module -F auid>=1000 -F auid!=unset -k kernel_modules
          -a always,exit -F path=/usr/bin/kmod -F perm=x -F auid>=1000 -F auid!=unset -k kernel_modules
        mode: '0640'
      notify: restart auditd

    - name: Make audit configuration immutable
      copy:
        dest: /etc/audit/rules.d/99-finalize.rules
        content: |
          -e 2
        mode: '0640'

    - name: Configure auditd - system halt on full
      lineinfile:
        path: /etc/audit/auditd.conf
        regexp: '^admin_space_left_action\s*='
        line: 'admin_space_left_action = halt'
        state: present

    # ====================================
    # JOURNALD CONFIGURATION
    # ====================================
    - name: Configure journald - compress logs
      lineinfile:
        path: /etc/systemd/journald.conf
        regexp: '^#?Compress='
        line: 'Compress=yes'
        state: present
      notify: restart journald

    - name: Configure journald - persistent storage
      lineinfile:
        path: /etc/systemd/journald.conf
        regexp: '^#?Storage='
        line: 'Storage=persistent'
        state: present
      notify: restart journald

    - name: Configure journald - forward to rsyslog
      lineinfile:
        path: /etc/systemd/journald.conf
        regexp: '^#?ForwardToSyslog='
        line: 'ForwardToSyslog=yes'
        state: present
      notify: restart journald

    # ====================================
    # CRON PERMISSIONS
    # ====================================
    - name: Set permissions on /etc/crontab
      file:
        path: /etc/crontab
        owner: root
        group: root
        mode: '0600'

    - name: Set permissions on /etc/cron.hourly
      file:
        path: /etc/cron.hourly
        owner: root
        group: root
        mode: '0700'

    - name: Set permissions on /etc/cron.daily
      file:
        path: /etc/cron.daily
        owner: root
        group: root
        mode: '0700'

    - name: Set permissions on /etc/cron.weekly
      file:
        path: /etc/cron.weekly
        owner: root
        group: root
        mode: '0700'

    - name: Set permissions on /etc/cron.monthly
      file:
        path: /etc/cron.monthly
        owner: root
        group: root
        mode: '0700'

    - name: Set permissions on /etc/cron.d
      file:
        path: /etc/cron.d
        owner: root
        group: root
        mode: '0700'

    - name: Ensure cron.deny doesn't exist
      file:
        path: /etc/cron.deny
        state: absent

    - name: Ensure at.deny doesn't exist
      file:
        path: /etc/at.deny
        state: absent

    - name: Create cron.allow
      file:
        path: /etc/cron.allow
        owner: root
        group: root
        mode: '0600'
        state: touch
        modification_time: preserve
        access_time: preserve

    - name: Create at.allow
      file:
        path: /etc/at.allow
        owner: root
        group: root
        mode: '0600'
        state: touch
        modification_time: preserve
        access_time: preserve

    # ====================================
    # SUDO CONFIGURATION
    # ====================================
    - name: Ensure sudo uses pty
      lineinfile:
        path: /etc/sudoers
        line: 'Defaults use_pty'
        validate: '/usr/sbin/visudo -cf %s'

    - name: Ensure sudo log file exists
      lineinfile:
        path: /etc/sudoers
        line: 'Defaults logfile="/var/log/sudo.log"'
        validate: '/usr/sbin/visudo -cf %s'

    - name: Create sudo log file
      file:
        path: /var/log/sudo.log
        state: touch
        owner: root
        group: root
        mode: '0600'
        modification_time: preserve
        access_time: preserve

    # ====================================
    # PAM - PASSWORD LOCKOUT
    # ====================================
    - name: Configure PAM faillock
      lineinfile:
        path: /etc/pam.d/common-auth
        line: 'auth required pam_faillock.so preauth silent audit deny=5 unlock_time=900'
        insertbefore: '^auth\s+\[success=1 default=ignore\]\s+pam_unix.so'

    - name: Configure PAM faillock authfail
      lineinfile:
        path: /etc/pam.d/common-auth
        line: 'auth [default=die] pam_faillock.so authfail audit deny=5 unlock_time=900'
        insertafter: '^auth\s+\[success=1 default=ignore\]\s+pam_unix.so'

    - name: Configure PAM faillock account
      lineinfile:
        path: /etc/pam.d/common-account
        line: 'account required pam_faillock.so'
        insertbefore: '^account\s+\[success=1 new_authtok_reqd=done default=ignore\]\s+pam_unix.so'

    # ====================================
    # SU COMMAND RESTRICTION
    # ====================================
    - name: Restrict su command to wheel group
      lineinfile:
        path: /etc/pam.d/su
        regexp: '^#auth\s+required\s+pam_wheel.so'
        line: 'auth required pam_wheel.so use_uid group=sudo'
        state: present

    # ====================================
    # UFW LOOPBACK TRAFFIC
    # ====================================
    - name: UFW - Allow loopback incoming
      ufw:
        rule: allow
        direction: in
        interface: lo

    - name: UFW - Allow loopback outgoing
      ufw:
        rule: allow
        direction: out
        interface: lo

    - name: UFW - Deny incoming from loopback network
      ufw:
        rule: deny
        direction: in
        from_ip: 127.0.0.0/8

    - name: UFW - Deny incoming from IPv6 loopback
      ufw:
        rule: deny
        direction: in
        from_ip: ::1

    # ====================================
    # CORE DUMPS
    # ====================================
    - name: Disable core dumps via limits
      lineinfile:
        path: /etc/security/limits.conf
        line: '* hard core 0'
        state: present

    - name: Disable core dumps via sysctl
      sysctl:
        name: fs.suid_dumpable
        value: '0'
        state: present
        sysctl_set: yes
        reload: yes

  handlers:
    - name: restart ssh
      systemd:
        name: ssh
        state: restarted

    - name: restart auditd
      command: service auditd restart

    - name: restart timesyncd
      systemd:
        name: systemd-timesyncd
        state: restarted

    - name: restart journald
      systemd:
        name: systemd-journald
        state: restarted
